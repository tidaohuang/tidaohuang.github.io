<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (1.8.0_51) on Thu Nov 21 01:57:12 IST 2019 -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>wt.pom.concurrent (WNC.HORSE.10.00.602)</title>
<meta name="date" content="2019-11-21">
<link rel="stylesheet" type="text/css" href="../../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../../script.js"></script>
</head>
<body>
<script type="text/javascript"><!--
    try {
        if (location.href.indexOf('is-external=true') == -1) {
            parent.document.title="wt.pom.concurrent (WNC.HORSE.10.00.602)";
        }
    }
    catch(err) {
    }
//-->
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar.top">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.top" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.top.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../overview-summary.html">Overview</a></li>
<li class="navBarCell1Rev">Package</li>
<li>Class</li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../index-files/index-1.html">Index</a></li>
<li><a href="../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../wt/pom/package-summary.html">Prev&nbsp;Package</a></li>
<li><a href="../../../wt/preference/package-summary.html">Next&nbsp;Package</a></li>
</ul>
<ul class="navList">
<li><a href="../../../index.html?wt/pom/concurrent/package-summary.html" target="_top">Frames</a></li>
<li><a href="package-summary.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip.navbar.top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<div class="header">
<h1 title="Package" class="title">Package&nbsp;wt.pom.concurrent</h1>
<div class="docSummary">
<div class="block">Provides a mechanism for executing multiple tasks concurrently using the same datastore
connection and transaction.</div>
</div>
<p>See:&nbsp;<a href="#package.description">Description</a></p>
</div>
<div class="contentContainer">
<ul class="blockList">
<li class="blockList">
<table class="typeSummary" border="0" cellpadding="3" cellspacing="0" summary="Exception Summary table, listing exceptions, and an explanation">
<caption><span>Exception Summary</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Exception</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="../../../wt/pom/concurrent/ConcurrentTransactionRollbackException.html" title="class in wt.pom.concurrent">ConcurrentTransactionRollbackException</a></td>
<td class="colLast">
<div class="block">This exception is thrown by a transaction operation that is executing as part
 of a larger transaction among separate threads where one of the other threads 
 has executed a transaction rollback.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../wt/pom/concurrent/SharedTransactionRollbackException.html" title="class in wt.pom.concurrent">SharedTransactionRollbackException</a></td>
<td class="colLast">
<div class="block">This exception is thrown by a transaction operation that is shared among
 threads where one of the other threads has executed a transaction rollback.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../wt/pom/concurrent/SharedTransactionSavepointRollbackException.html" title="class in wt.pom.concurrent">SharedTransactionSavepointRollbackException</a></td>
<td class="colLast">
<div class="block">This exception is thrown by a transaction operation that is shared among
 threads where one of the other threads has executed a transaction savepoint
 rollback.</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<a name="package.description">
<!--   -->
</a>
<h2 title="Package wt.pom.concurrent Description">Package wt.pom.concurrent Description</h2>
<div class="block">Provides a mechanism for executing multiple tasks concurrently using the same datastore
connection and transaction.

<p>
To use this multi-threaded, concurrent functionality, a collection of tasks must be 
submitted to an <code>ExecutorService</code> obtained from a singleton 
<code>wt.pom.concurrent.ExecutorServiceFactory</code>.  This ExecutorService implementation 
wraps the submitted tasks with code that establishes a new MethodContext, sets the 
<code>wt.method.POMHandlerIfc</code> instance to a new shared POMHandler implementation, and 
executes the wrapped task within a transaction block.   This effectively establishes a 
top level transaction for all of the work executed by each submitted task.  The tasks can
also be submitted so that the work is executed in a transaction that has already been
started by the calling code.   In this case, the calling code's thread takes part in the 
transaction in the same manner as the submitted tasks.
</p>
<p>
Each thread shares a <code>wt.pom.WTConnection</code> concurrently with all other threads.  However,
each thread has its own <code>wt.pom.TransactionManager</code> so it behaves as if each thread
is executing within its own transaction with the datastore connections tied together with a
two-phase commit.  It is important for clients to understand the subtleties of not sharing 
the TransactionManagers, such as testing for whether an object is new within the transaction.
TransactionManagers handle global Transaction maps and Transaction listener
lists so each concurrent thread will have seperate instances of these.  The
<a href="../../../wt/pom/Transaction.html#getSharedMap--"><code>Transaction.getSharedMap()</code></a> method provides access to a
<code>Map</code> that is shared by all threads that are part of the
transaction.   This Map instance supports concurrent access, but it is important
to treat all key and value objects in a thread safe manner.   For example, if a
WTCollection is stored in this map and multiple threads can put objects into
the collection, then this code must written with the appropriate
synchronization.
</p>
<p>
The logical transaction semantics are enforced as if executing all of the
operations serially within a single thread.  If any thread rolls back the 
transaction, then the transaction will be rolled back, the ExecutorService that 
manages the task threads will be shutdown immediately, and all other threads 
will have an <code>InterruptedException</code> or 
<a href="../../../wt/pom/concurrent/SharedTransactionRollbackException.html" title="class in wt.pom.concurrent"><code>SharedTransactionRollbackException</code></a> thrown.  The commit
behavior is implemented by synchronization barrier points within the
<a href="../../../wt/pom/Transaction.html#commit--"><code>Transaction.commit()</code></a>.  This means that threads may block at
these points waiting for other threads to reach these points.  It also requires
that the number of tasks is specified when instatiating the ExecutorService.
The number of tasks submitted must reach this fixed size before all tasks can
run to completion.
</p>
<p>
Due to the blocking nature of this implementation, it is important to ensure that the threads
sharing a transaction do not block each other in a way that can lead to deadlock.  A specific
consequence of this behavior is that the <code>ExecutorService</code> invoke
methods must not be used when the concurrent tasks share the transaction with the calling code.
A deadlock would occur because the tasks would block waiting for the calling thread to commit 
the transaction and the calling thread is blocked waiting for the tasks to complete.  However,
if the submit methods are used (which do not block), then the calling thread can complete
its work and commit the transaction.
</p>

<H3>
Example
</H3>
<p>
The following code implements a task that stores a WTCollection of objects.

<code><pre>
    public class StoreTask implements Callable&lt;WTCollection&gt;
    {
        private WTCollection objects;
        
        public StoreTask(WTCollection a_objects) 
        {
            objects = a_objects;
        }
                
        public WTCollection call() throws Exception
        {
            WTCollection result = PersistenceHelper.manager.store(objects);
                    
            return result;
        }       
    }
</pre></code>
</p>

<p>
The following code stores an array of WTCollections concurrently.

<code><pre>
    WTCollection[] objectCollections = ...;
                                  
    ExecutorServiceFactory factory = ExecutorServiceFactory.getDefault();
    ExecutorService executorService = factory.newExecutorService(objectCollections.length);

    for(int i = 0;i < objectCollections.length;i++)
    {
        Future&lt;WTCollection&gt; future = executorService.submit(new StoreTask(objectCollections[i]));
    }
</pre></code>
</p>

<p>
The following code stores an array of WTCollections concurrently within the existing transaction 
established by the calling code.

<code><pre>

    Transaction trx = new Transaction();
    try
    {
        trx.start();

        WTCollection[] objectCollections = ...;
                                  
        ExecutorServiceFactory factory = ExecutorServiceFactory.getDefault();
        ExecutorService executorService = factory.newExecutorService(objectCollections.length, true /* share transaction */);

        for(int i = 0;i < objectCollections.length;i++)
        {
                Future&lt;WTCollection&gt; future = executorService.submit(new StoreTask(objectCollections[i]));
        }
        
        trx.commit();
        trx = null;
    }
    finally
    {
        if (trx != null)
        {
            trx.rollback();
        }
    }

</pre></code>
</p></div>
</div>
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar.bottom">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.bottom" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.bottom.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../overview-summary.html">Overview</a></li>
<li class="navBarCell1Rev">Package</li>
<li>Class</li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../index-files/index-1.html">Index</a></li>
<li><a href="../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../wt/pom/package-summary.html">Prev&nbsp;Package</a></li>
<li><a href="../../../wt/preference/package-summary.html">Next&nbsp;Package</a></li>
</ul>
<ul class="navList">
<li><a href="../../../index.html?wt/pom/concurrent/package-summary.html" target="_top">Frames</a></li>
<li><a href="package-summary.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip.navbar.bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
</body>
</html>
